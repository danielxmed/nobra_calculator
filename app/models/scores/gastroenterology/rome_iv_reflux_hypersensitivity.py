"""
Rome IV Diagnostic Criteria for Reflux Hypersensitivity Models

Request and response models for Rome IV reflux hypersensitivity diagnostic assessment.

References (Vancouver style):
1. Aziz Q, Fass R, Gyawali CP, Miwa H, Pandolfino JE, Zerbib F. Esophageal disorders. 
   Gastroenterology. 2016 May;150(6):1368-1379. doi: 10.1053/j.gastro.2016.02.012.
2. Rome Foundation. Rome IV Diagnostic Criteria for Functional Gastrointestinal Disorders. 
   4th ed. Raleigh, NC: Rome Foundation; 2016.
3. Patel A, Gyawali CP. Reflux hypersensitivity: Current concepts and future directions. 
   Current Gastroenterology Reports. 2015 May;17(5):20. doi: 10.1007/s11894-015-0441-x.
4. Savarino E, de Bortoli N, De Cassan C, et al. The natural history of gastro-esophageal 
   reflux disease: a comprehensive review. Dis Esophagus. 2017 Feb 1;30(2):1-9. 
   doi: 10.1111/dote.12511.

The Rome IV diagnostic criteria for reflux hypersensitivity represent a significant 
paradigm shift in the classification of esophageal disorders, defining a distinct 
functional condition that bridges gastroesophageal reflux disease (GERD) and functional 
heartburn. This evidence-based diagnostic framework enables precise identification of 
patients with heightened esophageal sensitivity to physiologic amounts of gastroesophageal 
reflux.

Clinical Background and Pathophysiology:
Reflux hypersensitivity is a functional esophageal disorder affecting approximately 
7-15% of patients presenting with heartburn symptoms. The condition is characterized 
by normal acid exposure time (<4% total recording time with pH <4.0) on ambulatory 
pH monitoring, but with a significant temporal association between symptoms and reflux 
events. This represents a state of heightened visceral hypersensitivity where patients 
experience symptoms in response to physiologic amounts of gastroesophageal reflux 
that would not typically cause symptoms in healthy individuals.

Rome IV Classification Changes:
The Rome IV criteria introduced a major reclassification compared to Rome III, moving 
reflux hypersensitivity from the GERD spectrum into functional esophageal disorders. 
This change reflects enhanced understanding of the pathophysiology and recognition 
that these patients have fundamentally different mechanisms underlying their symptoms 
compared to typical GERD patients with abnormal acid exposure.

Key Diagnostic Requirements:
ALL of the following criteria must be fulfilled for at least 3 months, with symptom 
onset at least 6 months prior to diagnosis, and symptoms occurring at least twice weekly:

1. Retrosternal Symptom Pattern:
   - Heartburn: Burning sensation rising from stomach/lower chest toward neck
   - Chest pain: Non-cardiac chest pain localized to retrosternal area
   - Symptoms must be recurrent and characteristic of esophageal origin
   - Must meet temporal criteria: ≥3 months duration, onset ≥6 months ago, ≥2x/week frequency

2. Normal Endoscopic Findings:
   - Absence of erosive esophagitis (LA Grade A-D classification)
   - No Barrett's esophagus or other metaplastic changes
   - Normal appearing esophageal mucosa without ulceration or stricturing
   - May have mild mucosal changes not meeting criteria for erosive disease

3. Exclusion of Eosinophilic Esophagitis:
   - Normal esophageal histology on biopsy (<15 eosinophils per high-power field)
   - Absence of characteristic endoscopic findings (rings, furrows, plaques, strictures)
   - No response to dietary elimination or topical corticosteroids
   - Normal peripheral eosinophil count and absence of other allergic manifestations

4. Exclusion of Major Motor Disorders:
   - Normal esophageal manometry or absence of Chicago Classification disorders
   - No achalasia (impaired lower esophageal sphincter relaxation)
   - No EGJ outflow obstruction (elevated integrated relaxation pressure)
   - No major peristaltic disorders (absent peristalsis, diffuse esophageal spasm, jackhammer esophagus)
   - Normal esophageal body and lower esophageal sphincter function

5. Ambulatory pH Monitoring Findings:
   - Normal acid exposure time: <4.0% total recording time with pH <4.0
   - Positive symptom-reflux association using validated metrics:
     * Symptom Association Probability (SAP) >95%, or
     * Symptom Index (SI) >50%
   - Requires adequate symptom recording during monitoring period
   - pH-impedance monitoring may provide additional diagnostic information

6. Exclusion of Alarm Features:
   - No dysphagia (difficulty swallowing solids or liquids)
   - No unintentional weight loss (>10% body weight over 6 months)
   - No iron deficiency anemia without obvious source
   - No persistent vomiting or signs of gastric outlet obstruction
   - No cervical lymphadenopathy or other signs of malignancy

Diagnostic Investigations and Clinical Assessment:
The diagnosis of reflux hypersensitivity requires a systematic approach with specific 
investigations to fulfill Rome IV criteria:

Upper Endoscopy:
- High-definition white light endoscopy to assess mucosal integrity
- Careful evaluation for subtle mucosal changes and erosions
- Esophageal biopsies to exclude eosinophilic esophagitis
- Assessment for Barrett's esophagus and other complications

Esophageal Manometry:
- High-resolution manometry with Chicago Classification v4.0 interpretation
- Assessment of lower esophageal sphincter function and relaxation
- Evaluation of esophageal body peristalsis and contractility
- Exclusion of major motor disorders that could explain symptoms

Ambulatory pH Monitoring:
- 24-48 hour catheter-based or wireless pH monitoring
- Calculation of acid exposure time and symptom-reflux association
- Patient symptom diary correlation with pH data
- Consider pH-impedance monitoring for enhanced diagnostic accuracy

Additional Diagnostic Considerations:
- Proton pump inhibitor trial may be performed but response does not exclude diagnosis
- Impedance parameters (PSPW index, MNBI) may provide additional diagnostic value
- Psychological assessment for anxiety, depression, and somatization disorders
- Evaluation for functional dyspepsia and other overlapping conditions

Differential Diagnosis and Alternative Conditions:
The systematic exclusion of alternative diagnoses is essential for accurate classification:

GERD with Abnormal Acid Exposure:
- Acid exposure time ≥4.0% distinguishes typical GERD from reflux hypersensitivity
- May have erosive or non-erosive presentations
- Typically better response to acid suppression therapy
- May require higher PPI doses or twice-daily dosing

Functional Heartburn:
- Normal acid exposure time like reflux hypersensitivity
- Negative symptom-reflux association (SAP <95%, SI <50%)
- Represents pure functional disorder without reflux component
- Often requires visceral pain modulators and psychological interventions

Eosinophilic Esophagitis:
- Characterized by >15 eosinophils per high-power field on biopsy
- Distinctive endoscopic findings and association with food allergies
- Requires dietary elimination or topical corticosteroid therapy
- Different pathophysiology involving allergic inflammation

Major Esophageal Motor Disorders:
- Achalasia: Impaired LES relaxation with aperistalsis
- EGJ outflow obstruction: Elevated integrated relaxation pressure
- Diffuse esophageal spasm: Premature contractions with normal peristalsis
- Jackhammer esophagus: Hypercontractile peristalsis
- Absent peristalsis: Failed peristalsis in setting of normal LES

Clinical Management and Treatment Approach:
The management of reflux hypersensitivity requires a multimodal approach addressing 
both the reflux component and the underlying visceral hypersensitivity:

Acid Suppression Therapy:
- Proton pump inhibitors may be effective despite normal acid exposure
- Standard once-daily dosing initially, may require twice-daily dosing
- H2 receptor antagonists as alternative or adjunctive therapy
- Consider timing of administration relative to symptoms

Visceral Pain Modulators:
- Tricyclic antidepressants (amitriptyline, nortriptyline) for visceral hypersensitivity
- Gabapentinoids (gabapentin, pregabalin) for neuropathic-type pain
- Selective serotonin reuptake inhibitors for comorbid anxiety/depression
- Start with low doses and titrate based on response and tolerability

Lifestyle and Dietary Modifications:
- Weight reduction for overweight/obese patients
- Elevation of head of bed for nocturnal symptoms
- Avoidance of trigger foods (acidic, spicy, fatty foods)
- Meal timing modifications (smaller meals, avoid late evening eating)
- Alcohol and tobacco cessation

Psychological Interventions:
- Cognitive behavioral therapy for symptom-focused anxiety
- Stress management and relaxation techniques
- Mindfulness-based interventions for chronic pain management
- Hypnotherapy for functional gastrointestinal disorders

Prognosis and Long-term Outcomes:
Reflux hypersensitivity generally has a favorable prognosis with appropriate management. 
Many patients experience significant symptom improvement with multimodal therapy, 
although complete symptom resolution may be challenging. The condition tends to be 
chronic with fluctuating symptom severity, often influenced by stress and psychological 
factors. Long-term follow-up focuses on symptom management, quality of life optimization, 
and monitoring for development of complications.

Quality of Life and Functional Impact:
Patients with reflux hypersensitivity often experience significant impairment in 
quality of life, work productivity, and social functioning. The unpredictable nature 
of symptoms and concern about underlying pathology can contribute to anxiety and 
health-related worry. Patient education about the benign nature of the condition 
and reassurance about the absence of serious underlying disease are essential 
components of management.

Research and Future Directions:
Current research focuses on enhanced diagnostic techniques including high-resolution 
impedance manometry, mucosal integrity assessment, and biomarkers of visceral 
hypersensitivity. Novel therapeutic approaches under investigation include 
neuromodulation techniques, targeted pharmacotherapy for visceral hypersensitivity, 
and personalized treatment approaches based on individual pathophysiologic mechanisms.
"""

from pydantic import BaseModel, Field
from typing import Literal


class RomeIvRefluxHypersensitivityRequest(BaseModel):
    """
    Request model for Rome IV Diagnostic Criteria for Reflux Hypersensitivity
    
    The Rome IV criteria for reflux hypersensitivity provide evidence-based diagnostic 
    standards for identifying patients with heightened esophageal sensitivity to 
    physiologic amounts of gastroesophageal reflux. This functional esophageal disorder 
    requires systematic evaluation and specific investigations for accurate diagnosis.
    
    Temporal Requirements:
    All criteria must be fulfilled for the last 3 months, with symptom onset at least 
    6 months prior to diagnosis, and symptoms occurring at least twice per week.
    
    Clinical Assessment Guidelines:
    
    Symptom Characterization:
    - Retrosternal heartburn: burning sensation rising from stomach/lower chest toward neck
    - Retrosternal chest pain: non-cardiac pain localized to retrosternal area
    - Symptoms must be recurrent and characteristic of esophageal origin
    - Document relationship to meals, position, and potential triggers
    
    Endoscopic Evaluation:
    - High-definition white light endoscopy to assess mucosal integrity
    - Systematic evaluation using Los Angeles Classification for erosive esophagitis
    - Normal findings: absence of erosions, ulcers, strictures, or Barrett's esophagus
    - Consider narrow-band imaging for enhanced mucosal assessment
    
    Histologic Assessment:
    - Esophageal biopsies from distal and mid-esophagus (minimum 2-4 biopsies per level)
    - Eosinophil count <15 per high-power field to exclude eosinophilic esophagitis
    - Assessment for inflammatory changes, architectural distortion, or other abnormalities
    - Consider special stains if specific conditions suspected
    
    Esophageal Function Testing:
    - High-resolution manometry with Chicago Classification v4.0 interpretation
    - Assessment of lower esophageal sphincter pressure and relaxation
    - Evaluation of esophageal body peristalsis and contractility patterns
    - Exclusion of major motor disorders requiring specific management
    
    Ambulatory pH Monitoring:
    - 24-48 hour catheter-based or wireless pH monitoring systems
    - Patient instruction for accurate symptom recording and diary completion
    - Normal acid exposure time: <4.0% total recording time with pH <4.0
    - Positive symptom-reflux association: SAP >95% or SI >50%
    - Consider pH-impedance monitoring for enhanced diagnostic accuracy
    
    Alarm Symptom Assessment:
    - Dysphagia: difficulty swallowing requiring systematic evaluation
    - Unintentional weight loss: >10% body weight over 6 months
    - Iron deficiency anemia: evaluate for gastrointestinal bleeding source
    - Persistent vomiting: consider gastric outlet obstruction or other causes
    - Cervical lymphadenopathy: evaluate for malignancy or infectious causes
    
    Differential Diagnosis Considerations:
    - GERD with abnormal acid exposure: acid exposure time ≥4.0%
    - Functional heartburn: normal acid exposure with negative symptom association
    - Eosinophilic esophagitis: >15 eosinophils per hpf on biopsy
    - Achalasia: impaired LES relaxation with aperistalsis on manometry
    - Coronary artery disease: exclude cardiac etiology for chest pain
    
    References: See module docstring for complete citation list.
    """
    
    retrosternal_symptoms: Literal["yes", "no"] = Field(
        ...,
        description="Retrosternal symptoms including heartburn and chest pain for at least 3 months with onset ≥6 months ago, occurring ≥2 times per week. Symptoms must be characteristic of esophageal origin.",
        example="yes"
    )
    
    normal_endoscopy: Literal["yes", "no"] = Field(
        ...,
        description="Normal endoscopy findings without evidence of erosive esophagitis or other mucosal abnormalities. Upper endoscopy shows normal esophageal mucosa using Los Angeles Classification.",
        example="yes"
    )
    
    absence_eosinophilic_esophagitis: Literal["yes", "no"] = Field(
        ...,
        description="Absence of evidence of eosinophilic esophagitis (EoE) on endoscopy and biopsy. Esophageal biopsy shows <15 eosinophils per high-power field.",
        example="yes"
    )
    
    absence_major_motor_disorders: Literal["yes", "no"] = Field(
        ...,
        description="Absence of major esophageal motor disorders on manometry. No achalasia, EGJ outflow obstruction, diffuse esophageal spasm, jackhammer esophagus, or absent peristalsis.",
        example="yes"
    )
    
    normal_acid_exposure_with_symptom_association: Literal["yes", "no"] = Field(
        ...,
        description="Evidence of symptom triggering by reflux events despite normal acid exposure on pH monitoring. Normal acid exposure time (<4%) with positive symptom-reflux association (SAP >95% or SI >50%).",
        example="yes"
    )
    
    exclusion_alarm_symptoms: Literal["yes", "no"] = Field(
        ...,
        description="Exclusion of alarm symptoms requiring further evaluation. No dysphagia, weight loss, iron deficiency anemia, persistent vomiting, or cervical lymphadenopathy.",
        example="yes"
    )
    
    class Config:
        schema_extra = {
            "example": {
                "retrosternal_symptoms": "yes",
                "normal_endoscopy": "yes",
                "absence_eosinophilic_esophagitis": "yes",
                "absence_major_motor_disorders": "yes",
                "normal_acid_exposure_with_symptom_association": "yes",
                "exclusion_alarm_symptoms": "yes"
            }
        }


class RomeIvRefluxHypersensitivityResponse(BaseModel):
    """
    Response model for Rome IV Diagnostic Criteria for Reflux Hypersensitivity
    
    The Rome IV diagnostic assessment for reflux hypersensitivity provides evidence-based 
    classification that guides appropriate clinical management and treatment planning. 
    Understanding the diagnostic outcome is essential for optimal patient care and 
    therapeutic decision-making in functional esophageal disorders.
    
    Diagnostic Interpretations and Clinical Management:
    
    Criteria Met (Positive Diagnosis):
    - All 6 Rome IV criteria fulfilled for reflux hypersensitivity
    - Confirms functional esophageal disorder with visceral hypersensitivity
    - Distinct from GERD (normal acid exposure) and functional heartburn (positive symptom association)
    - Requires multimodal treatment approach addressing both reflux and hypersensitivity components
    
    Clinical Management for Positive Diagnosis:
    
    Pharmacological Interventions:
    - Acid suppression therapy: PPI once or twice daily despite normal acid exposure
    - Visceral pain modulators: tricyclic antidepressants (amitriptyline 10-50mg) or gabapentinoids
    - Consider H2 receptor antagonists as alternative or adjunctive therapy
    - Prokinetic agents may help with symptom management in selected patients
    
    Non-Pharmacological Approaches:
    - Patient education about benign nature and functional etiology of symptoms
    - Lifestyle modifications: weight reduction, dietary changes, meal timing
    - Stress management techniques and relaxation training
    - Cognitive behavioral therapy for symptom-focused anxiety and pain management
    - Sleep hygiene and elevation of head of bed for nocturnal symptoms
    
    Dietary and Lifestyle Modifications:
    - Avoidance of trigger foods: acidic, spicy, fatty, or carbonated items
    - Smaller, more frequent meals to reduce gastric distension
    - Avoid eating within 3 hours of bedtime
    - Weight reduction for overweight/obese patients
    - Alcohol moderation and tobacco cessation
    
    Psychological Support:
    - Reassurance about absence of serious underlying pathology
    - Education about visceral hypersensitivity and central sensitization
    - Stress reduction techniques and mindfulness-based interventions
    - Support for anxiety management related to symptoms
    - Consider referral to behavioral health specialists for complex cases
    
    Follow-up and Monitoring:
    - Regular assessment of symptom response and quality of life impact
    - Medication titration based on efficacy and tolerability
    - Long-term management strategy with emphasis on functional improvement
    - Monitor for development of complications or change in symptom pattern
    
    Criteria Not Met (Negative Diagnosis):
    - One or more Rome IV criteria not fulfilled
    - Alternative diagnoses should be systematically considered
    - Further evaluation may be needed based on specific findings
    - Targeted investigation and management of identified conditions
    
    Alternative Diagnoses and Further Evaluation:
    
    GERD with Abnormal Acid Exposure:
    - Acid exposure time ≥4.0% on ambulatory pH monitoring
    - May have erosive or non-erosive presentations
    - Typically better response to standard acid suppression therapy
    - Consider surgical intervention for refractory cases with proven reflux
    
    Functional Heartburn:
    - Normal acid exposure time similar to reflux hypersensitivity
    - Negative symptom-reflux association (SAP <95%, SI <50%)
    - Represents pure functional disorder requiring visceral pain modulators
    - Focus on psychological interventions and central sensitization treatment
    
    Eosinophilic Esophagitis:
    - >15 eosinophils per high-power field on esophageal biopsy
    - Characteristic endoscopic findings: rings, furrows, plaques, strictures
    - Association with food allergies and atopic conditions
    - Requires dietary elimination therapy or topical corticosteroids
    
    Major Esophageal Motor Disorders:
    - Achalasia: impaired LES relaxation requiring pneumatic dilation or surgery
    - EGJ outflow obstruction: elevated integrated relaxation pressure
    - Diffuse esophageal spasm: premature contractions with chest pain
    - Jackhammer esophagus: hypercontractile peristalsis
    - Absent peristalsis: failed peristalsis requiring specialized management
    
    Cardiac Conditions:
    - Coronary artery disease: exercise stress testing or cardiac catheterization
    - Pericarditis or other cardiac inflammatory conditions
    - Aortic dissection in acute presentations with severe chest pain
    - Consider cardiology consultation for atypical presentations
    
    Other Esophageal Conditions:
    - Esophageal malignancy: biopsy and staging if suspicious lesions
    - Infectious esophagitis: viral, fungal, or bacterial causes
    - Pill-induced esophagitis: medication history and endoscopic findings
    - Caustic injury: history of ingestion and characteristic findings
    
    Recommended Further Investigations:
    - Repeat upper endoscopy with systematic biopsy protocol
    - High-resolution esophageal manometry with provocative testing
    - Extended ambulatory pH-impedance monitoring (48-96 hours)
    - Cross-sectional imaging (CT chest) if structural abnormalities suspected
    - Cardiac evaluation if chest pain characteristics suggest cardiac etiology
    
    Quality Assurance and Follow-up:
    - Documentation of diagnostic criteria assessment and rationale
    - Clear communication of diagnosis and management plan to patient
    - Coordination with gastroenterology and other specialists as needed
    - Regular monitoring of symptom response and quality of life
    - Reassessment if significant change in clinical presentation
    
    Patient Education and Counseling:
    - Explanation of functional nature of disorder and absence of structural pathology
    - Discussion of treatment options and realistic expectations for symptom improvement
    - Importance of lifestyle modifications and stress management
    - Instructions for when to seek medical attention for concerning symptoms
    - Support resources for chronic functional disorders
    
    Prognosis and Long-term Outlook:
    - Generally favorable prognosis with appropriate multimodal management
    - Chronic condition with fluctuating symptom severity over time
    - Quality of life improvement possible with comprehensive treatment approach
    - Emphasis on functional improvement rather than complete symptom elimination
    - Long-term follow-up for optimization of management and support
    
    The Rome IV criteria enable evidence-based diagnosis of reflux hypersensitivity, 
    facilitating appropriate management strategies that address both the reflux component 
    and underlying visceral hypersensitivity to optimize patient outcomes and quality of life.
    
    Reference: See module docstring for complete citation list.
    """
    
    result: str = Field(
        ...,
        description="Rome IV diagnostic assessment result for reflux hypersensitivity (Criteria Met or Criteria Not Met)",
        example="Criteria Met"
    )
    
    unit: str = Field(
        ...,
        description="Unit of measurement for the diagnostic assessment",
        example="diagnosis"
    )
    
    interpretation: str = Field(
        ...,
        description="Comprehensive clinical interpretation including diagnostic assessment, treatment recommendations, differential diagnosis considerations, and multimodal management guidance based on Rome IV criteria fulfillment.",
        example="Patient fulfills Rome IV diagnostic criteria for reflux hypersensitivity. Diagnosis is established when all criteria are met including retrosternal symptoms, normal endoscopy, exclusion of eosinophilic esophagitis and motor disorders, and demonstration of normal acid exposure with positive symptom-reflux association. Treatment options include acid suppression therapy, visceral pain modulators, psychological interventions, and lifestyle modifications."
    )
    
    stage: str = Field(
        ...,
        description="Rome IV diagnostic category (Criteria Met or Criteria Not Met)",
        example="Criteria Met"
    )
    
    stage_description: str = Field(
        ...,
        description="Brief description of the diagnostic assessment outcome",
        example="Meets Rome IV criteria"
    )
    
    class Config:
        schema_extra = {
            "example": {
                "result": "Criteria Met",
                "unit": "diagnosis",
                "interpretation": "Patient fulfills Rome IV diagnostic criteria for reflux hypersensitivity. Diagnosis is established when all criteria are met including retrosternal symptoms, normal endoscopy, exclusion of eosinophilic esophagitis and motor disorders, and demonstration of normal acid exposure with positive symptom-reflux association. Treatment options include acid suppression therapy, visceral pain modulators, psychological interventions, and lifestyle modifications.",
                "stage": "Criteria Met",
                "stage_description": "Meets Rome IV criteria"
            }
        }